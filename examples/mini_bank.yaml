topology:
  services:
    ads:
      tagSets:
        - weight: 1
          tags:
            version: 3.7.1
            region: us-east-1
      resourceAttrSets:
        - weight: 1
          kubernetes:
            cluster_name: k8s-cluster-10
            request:
              cpu: 0.5
              memory: 512
            limit:
              cpu: 1
              memory: 1024
          resourceAttrs:
            host.name: ads-hostname
      routes:
        /AdRequest:
          downstreamCalls:
          latencyConfigs:
            - flag_set: ads_bug.slow
              p0: 30ms
              p50: 100ms
              p95: 170ms
              p99: 200ms
              p99.9: 300ms
              p100: 500ms
            - flag_set: ads_bug.slower
              p0: 40ms
              p50: 125ms
              p95: 200ms
              p99: 300ms
              p99.9: 450ms
              p100: 600ms
            - p0: 25ms
              p50: 75ms
              p95: 100ms
              p99: 120ms
              p99.9: 150ms
              p100: 200ms
        /Ad:
          downstreamCalls:
          maxLatencyMillis: 500
    android:
      resourceAttrSets:
        - weight: 1
          resourceAttrs:
            instrument.name: lightstep
            http.method: POST
            client.platform: android
      metrics:
        - name: requests
          type: Sum
          max: 400
          min: 0
          period: 5m
          shape: triangle
      routes:
        /login:
          downstreamCalls:
            - service: api-gateway
              route: /GetAuthentication
          maxLatencyMillis: 100
        /api/make-payment:
          downstreamCalls:
            - service: android
              route: /api/submit-payment
          maxLatencyMillis: 100
        /api/submit-payment:
          downstreamCalls:
            - service: android
              route: /api/payment-status
          maxLatencyMillis: 100
        /api/payment-status:
          downstreamCalls:
          maxLatencyMillis: 100
    api-gateway:
      tagSets:
        - weight: 1
          tags:
            version: 1.0.0
      resourceAttrSets:
        - weight: 1
          kubernetes:
            pod_count: 10
            restart:
              every: 10m
              jitter: 2m
            cluster_name: k8s-cluster-23
            request:
              cpu: 0.5
              memory: 2048
            limit:
              cpu: 0.75
              memory: 3072
            usage:
              cpu:
                target: 0.5
                jitter: 0.5
              memory:
                target: 0.6
                jitter: 0.4
          resourceAttrs:
            cloud.provider: aws
            cloud.region: us-east-1
        - weight: 1
          kubernetes:
            cluster_name: k8s-cluster-1
            request:
              cpu: 0.5
              memory: 2048
            limit:
              cpu: 0.75
              memory: 3072
            restart:
              every: 5m
          resourceAttrs:
            cloud.provider: aws
            cloud.region: us-west-2
      routes:
        /GetAuthentication:
          downstreamCalls:
            - service: authentication
              route: /login
          maxLatencyMillis: 100
        /getPayment:
          downstreamCalls:
            - service: payment
              route: /CardPayment
          maxLatencyMillis: 100
    authentication:
      tagSets:
        - weight: 1
          flag_set: auth_errors
          tags:
            version: 3.4.0
            error: true
        - weight: 1
          flag_unset: auth_errors
          tags:
            version: 3.3.5
      routes:
        /login:
          maxLatencyMillis: 100
        /logout:
          maxLatencyMillis: 100
    ext-api-gateway:
      tagSets:
        - weight: 1
          tags:
            version: 1.0.0
      resourceAttrSets:
        - weight: 1
          kubernetes:
            pod_count: 10
            restart:
              every: 10m
              jitter: 2m
            cluster_name: k8s-cluster-23
            request:
              cpu: 0.5
              memory: 2048
            limit:
              cpu: 0.75
              memory: 3072
            usage:
              cpu:
                target: 0.5
                jitter: 0.5
              memory:
                target: 0.6
                jitter: 0.4
          resourceAttrs:
            cloud.provider: aws
            cloud.region: us-east-1
        - weight: 1
          kubernetes:
            cluster_name: k8s-cluster-2
            request:
              cpu: 0.5
              memory: 2048
            limit:
              cpu: 0.75
              memory: 3072
            restart:
              every: 5m
          resourceAttrs:
            cloud.provider: aws
            cloud.region: us-west-2
      routes:
        /ext-api/payment:
          maxLatencyMillis: 500
        /paymentAMEX:
          maxLatencyMillis: 100
        /paymentMASTERCARD:
          maxLatencyMillis: 100
        /paymentVISA:
          maxLatencyMillis: 100
        /transferPartner-MorganStanley:
          maxLatencyMillis: 100
        /transferSWIFT:
          maxLatencyMillis: 100
    iOS:
      tagSets:
        - weight: 1
          flag_set: iOS_errors
          tags:
            version: 5.4.231
            error: true
        - weight: 1
          flag_unset: iOS_errors
          tags:
            version: 5.4.231
      resourceAttrSets:
        - weight: 1
          resourceAttrs:
            instrument.name: lightstep
            http.method: POST
            client.platform: iOS
      metrics:
        - name: requests
          type: Sum
          max: 400
          min: 0
          period: 5m
          shape: triangle
      routes:
        /login:
          downstreamCalls:
            - service: api-gateway
              route: /GetAuthentication
          maxLatencyMillis: 100
        /api/make-payment:
          downstreamCalls:
            - service: iOS
              route: /api/submit-payment
          maxLatencyMillis: 100
        /api/submit-payment:
          downstreamCalls:
            - service: api-gateway
              route: /getPayment
            - service: iOS
              route: /api/payment-status
          maxLatencyMillis: 100
        /api/payment-status:
          maxLatencyMillis: 100
    loan:
      tagSets:
        - weight: 1
          tags:
            version: 10.4.214
      routes:
        /getAgreement:
          maxLatencyMillis: 100
        /getScoring:
          maxLatencyMillis: 100
        /postLoanInputs:
          maxLatencyMillis: 100
        /postScoringInputs:
          maxLatencyMillis: 100
    payment:
      tagSets:
        - weight: 1
          tags:
            version: v177
            region: us-east-1
      resourceAttrSets:
        - weight: 1
          kubernetes:
            cluster_name: k8s-cluster-6
            request:
              cpu: 0.5
              memory: 512
            limit:
              cpu: 1
              memory: 1024
          resourceAttrs:
            host.name: payment-hostname
      routes:
        /ChargeRequest:
          downstreamCalls:
            - service: payment
              route: /CreditCardInfo
          maxLatencyMillis: 700
        /CreditCardInfo:
          downstreamCalls:
          tagSets:
            - weight: 1
              tags:
                card.type: AMEX
            - weight: 1
              tags:
                card.type: VISA
            - weight: 1
              tags:
                card.type: MASTERDCARD
          maxLatencyMillis: 50
        /CardPayment:
          downstreamCalls:
            - service: payment
              route: /ChargeRequest
            - weight: 1
              service: ext-api-gateway
              route: /ext-api/payment
          maxLatencyMillis: 1000
    web:
      tagSets:
        - weight: 1
          tags:
            version: 1.2.5
      resourceAttrSets:
        - weight: 1
          kubernetes:
            pod_count: 7
            restart:
              every: 10m
              jitter: 2m
            cluster_name: k8s-cluster-23
            request:
              cpu: 0.5
              memory: 2048
            limit:
              cpu: 0.75
              memory: 3072
            usage:
              cpu:
                target: 0.5
                jitter: 0.5
              memory:
                target: 0.6
                jitter: 0.4
          resourceAttrs:
            cloud.provider: aws
            cloud.region: us-east-1
        - weight: 1
          kubernetes:
            cluster_name: k8s-cluster-1
            request:
              cpu: 0.5
              memory: 2048
            limit:
              cpu: 0.75
              memory: 3072
            restart:
              every: 5m
          resourceAttrs:
            cloud.provider: aws
            cloud.region: us-west-2
      routes:
        /login:
          downstreamCalls:
            - service: api-gateway
              route: /GetAuthentication
          maxLatencyMillis: 100
        /api/make-payment:
          downstreamCalls:
            - service: web
              route: /api/submit-payment
          maxLatencyMillis: 100
        /api/submit-payment:
          maxLatencyMillis: 100

flags:
  # This is a cron-style flag
  - name: auth_errors
    # use https://crontab.guru/
    cron:
      start: "0,10,20,30,40,50 * * * *"
      end: "5,15,25,35,45,55 * * * *"
  - name: iOS_errors
    # use https://crontab.guru/
    cron:
      start: "0,10,20,30,40,50 * * * *"
      end: "5,15,25,35,45,55 * * * *"
  - name: runs_on_azure
  - name: sev0_total_failure
  - name: database_outage
  # OOM on currency service + slower span latency from frontend -> currencyservice
  - name: currencyservice_oom.default
    incident:
      parentFlag: currencyservice_fail
      start: 0m
      duration: 10m
  - name: currencyservice_oom.phase_1
    incident:
      parentFlag: currencyservice_fail
      start: 0m
      duration: 10m
  - name: currencyservice_oom.phase_2
    incident:
      parentFlag: currencyservice_fail
      start: 3m
      duration: 7m
  - name: auth_doom
    cron:
      start: "57,12,27,42 * * * *"
      end: "10,25,40,55 * * * *"
  # This is an incident-style flag; start and end are relative to incident start
  - name: auth_doom.phase_1
    incident:
      parentFlag: auth_doom
      start: 0m
      end: 10m
  - name: auth_doom.phase_2
    incident:
      parentFlag: auth_doom
      start: 5m
      # with no duration, lasts until the incident finishes
  - name: currencyservice_fail
    cron:
      start: "57,12,27,42 * * * *"
      end: "10,25,40,55 * * * *"
  - name: ads_bug
    cron:
      start: "0,20,40 * * * *"
      end: "10,30,50 * * * *"
  - name: ads_bug.slow
    incident:
      parentFlag: ads_bug
      start: 0m, 7m
      duration: 3m
  - name: ads_bug.slower
    incident:
      parentFlag: ads_bug
      start: 3m
      duration: 4m

rootRoutes:
  - service: android
    route: /login
    tracesPerHour: 2000
  - service: iOS
    route: /login
    tracesPerHour: 2880
  - service: web
    route: /login
    tracesPerHour: 1440
  - service: iOS
    route: /api/make-payment
    tracesPerHour: 480
  - service: android
    route: /api/make-payment
    tracesPerHour: 480

config:
  kubernetes:
    pod_count: 1
